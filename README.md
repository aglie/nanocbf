# nanocbf

A minimal, fast C++ library for reading and writing CBF (Crystallographic Binary Format) files.

## Features

- **Simple API**: Very minimal API, which provides no help in reading cif headers.
- **No dependencies**: Pure C++11, no external libraries required
- **Compatible**: Tested on CBF files measured with PILATUS detectors and generated by XDS.

## Quick Start

```cpp
#include "cbfframe_simple.h"

// Write CBF file
CbfFrame frame;
frame.data = {100, 200, 300, 400};  // 1D vector of pixel values
frame.width = 2;
frame.height = 2;
frame.header = ""; // Empty = use default header
frame.write("output.cbf");

// Read CBF file
CbfFrame readFrame;
readFrame.read("input.cbf");
std::cout << "Size: " << readFrame.width << "x" << readFrame.height << std::endl;
```

## Build

```bash
mkdir build && cd build
cmake ..
make
```

## Complete Example

```cpp
#include <iostream>
#include <vector>
#include "cbfframe_simple.h"

int main() {
    // ===== WRITING CBF FILES =====
    
    // Create a simple 3x3 detector image
    std::vector<int32_t> imageData = {
        10,  20,  30,
        40,  50,  60, 
        70,  80,  90
    };
    
    CbfFrame frame;
    frame.data = imageData;
    frame.width = 3;
    frame.height = 3;
    
    // Option 1: Use default header (minimal)
    frame.header = "";
    if (frame.write("simple_output.cbf")) {
        std::cout << "✓ Wrote simple CBF file" << std::endl;
    }
    
    // Option 2: Use custom header with detector info
    frame.header = R"(_array_data.header_convention "PILATUS_1.2"
_array_data.header_contents
;
# Detector: PILATUS 100K, S/N 60-0100
# 2024-07-09T15:30:00.000
# Pixel_size 172e-6 m x 172e-6 m
# Silicon sensor, thickness 0.000320 m
# Exposure_time 1.0000 s
# Exposure_period 1.0000 s
# Tau = 124.0e-09 s
# Count_cutoff 388705 counts
# Threshold_setting: 8000 eV
# Gain_setting: low gain (vrf = -0.300)
# Wavelength 1.54180 A
# Energy_range (0, 0) eV
# Detector_distance 0.100 m
# Detector_Voffset 0.00000 m
# Beam_xy (1.50, 1.50) pixels
# Flux 1000000.0
# Filter_transmission 100.0000
# Start_angle 0.0000 deg.
# Angle_increment 0.1000 deg.
# Detector_2theta 0.0000 deg.
# Polarization 0.990
# Alpha 0.0000 deg.
# Kappa 0.0000 deg.
# Phi 0.0000 deg.
# Phi_increment 0.1000 deg.
# Omega 0.0000 deg.
# Omega_increment 0.0000 deg.
# Chi 0.0000 deg.
# Chi_increment 0.0000 deg.
# Oscillation_axis PHI
# N_oscillations 1
;

)";
    
    if (frame.write("detailed_output.cbf")) {
        std::cout << "✓ Wrote detailed CBF file" << std::endl;
    }
    
    // ===== READING CBF FILES =====
    
    // Read the file we just created
    CbfFrame readFrame;
    if (readFrame.read("detailed_output.cbf")) {
        std::cout << "✓ Successfully read CBF file" << std::endl;
        
        // Print basic info
        std::cout << "Dimensions: " << readFrame.width << "x" << readFrame.height << std::endl;
        std::cout << "Total pixels: " << readFrame.data.size() << std::endl;
        
        // Print extracted header
        std::cout << "Extracted header:" << std::endl;
        std::cout << readFrame.header << std::endl;
        
        // Process the data - example: calculate statistics
        int32_t minVal = *std::min_element(readFrame.data.begin(), readFrame.data.end());
        int32_t maxVal = *std::max_element(readFrame.data.begin(), readFrame.data.end());
        int64_t sum = 0;
        for (int32_t val : readFrame.data) {
            sum += val;
        }
        double mean = (double)sum / readFrame.data.size();
        
        std::cout << "Statistics:" << std::endl;
        std::cout << "  Min: " << minVal << std::endl;
        std::cout << "  Max: " << maxVal << std::endl;
        std::cout << "  Mean: " << mean << std::endl;
        
    } else {
        std::cout << "✗ Failed to read CBF file: " << readFrame.getError() << std::endl;
    }
    
    return 0;
}
```

## API Reference

### CbfFrame Class

**Public Fields:**
- `std::string header` - Text header content (leave empty for default)
- `std::vector<int32_t> data` - 1D vector of pixel values
- `int width` - Image width in pixels
- `int height` - Image height in pixels

**Methods:**
- `bool read(const std::string& filename)` - Read CBF file
- `bool write(const std::string& filename)` - Write CBF file
- `const std::string& getError()` - Get error message